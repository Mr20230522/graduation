<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.booking.mapper.BookingMapper">

    <!-- ==================== 结果映射 ==================== -->
    <resultMap type="com.ruoyi.booking.domain.DeptCarSpace" id="CarSpaceResult">
        <id property="id" column="id"/>
        <result property="deptId" column="dept_id"/>
        <result property="spaceNo" column="space_no"/>
        <result property="spaceName" column="space_name"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap type="com.ruoyi.booking.domain.DeptSchedule" id="ScheduleResult">
        <id property="id" column="id"/>
        <result property="deptId" column="dept_id"/>
        <result property="workDate" column="work_date"/>
        <result property="openTime" column="open_time"/>
        <result property="closeTime" column="close_time"/>
        <result property="slotMinutes" column="slot_minutes"/>
        <result property="carSpaces" column="car_spaces"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap type="com.ruoyi.booking.domain.CarBooking" id="BookingResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="bookingNo" column="booking_no"/>
        <result property="deptId" column="dept_id"/>
        <result property="spaceNo" column="space_no"/>
        <result property="workDate" column="work_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="carNumber" column="car_number"/>
        <result property="carModel" column="car_model"/>
        <result property="carColor" column="car_color"/>
        <result property="comboName" column="combo_name"/>
        <result property="comboMinutes" column="combo_minutes"/>
        <result property="code" column="code"/>
        <result property="status" column="status"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- ==================== 车位 ==================== -->
    <sql id="selectCarSpaceVo">
        SELECT id, dept_id, space_no, space_name, status, create_time, update_time
        FROM dept_car_space
    </sql>

    <select id="selectCarSpaceList" parameterType="com.ruoyi.booking.domain.DeptCarSpace" resultMap="CarSpaceResult">
        <include refid="selectCarSpaceVo"/>
        <where>
            <if test="deptId != null">AND dept_id = #{deptId}</if>
            <if test="spaceNo != null and spaceNo != ''">AND space_no = #{spaceNo}</if>
            <if test="spaceName != null and spaceName != ''">AND space_name LIKE CONCAT('%', #{spaceName}, '%')</if>
            <if test="status != null">AND status = #{status}</if>
        </where>
        ORDER BY space_no
    </select>

    <select id="selectCarSpaceByDeptId" resultMap="CarSpaceResult">
        <include refid="selectCarSpaceVo"/>
        WHERE dept_id = #{deptId} AND status = 0
        ORDER BY space_no
    </select>

    <insert id="insertCarSpace" parameterType="com.ruoyi.booking.domain.DeptCarSpace">
        INSERT INTO dept_car_space
            (dept_id, space_no, space_name, status, create_time)
        VALUES
            (#{deptId}, #{spaceNo}, #{spaceName}, #{status}, NOW())
    </insert>

    <update id="updateCarSpace" parameterType="com.ruoyi.booking.domain.DeptCarSpace">
        UPDATE dept_car_space
        <trim prefix="SET" suffixOverrides=",">
            <if test="deptId != null">dept_id = #{deptId},</if>
            <if test="spaceNo != null">space_no = #{spaceNo},</if>
            <if test="spaceName != null">space_name = #{spaceName},</if>
            <if test="status != null">status = #{status},</if>
            update_time = NOW()
        </trim>
        WHERE id = #{id}
    </update>

    <delete id="deleteCarSpaceByIds">
        DELETE FROM dept_car_space WHERE id IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- ==================== 排班 ==================== -->
    <sql id="selectScheduleVo">
        SELECT id, dept_id, work_date, open_time, close_time, slot_minutes, car_spaces, status, create_time, update_time
        FROM dept_schedule
    </sql>

    <select id="selectScheduleList" parameterType="com.ruoyi.booking.domain.DeptSchedule" resultMap="ScheduleResult">
        <include refid="selectScheduleVo"/>
        <where>
            <if test="deptId != null">AND dept_id = #{deptId}</if>
            <if test="workDate != null">AND work_date = #{workDate}</if>
            <if test="status != null">AND status = #{status}</if>
        </where>
        ORDER BY work_date
    </select>

    <select id="selectScheduleByDeptIdAndDateRange" resultMap="ScheduleResult">
        <include refid="selectScheduleVo"/>
        WHERE dept_id = #{deptId}
        AND work_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY work_date
    </select>

    <select id="selectScheduleByDeptIdAndDate" resultMap="ScheduleResult">
        <include refid="selectScheduleVo"/>
        WHERE dept_id = #{deptId} AND work_date = #{workDate}
    </select>

    <insert id="insertSchedule" parameterType="com.ruoyi.booking.domain.DeptSchedule">
        INSERT INTO dept_schedule
        (dept_id, work_date, open_time, close_time, slot_minutes, car_spaces, status, create_time)
        VALUES
            (#{deptId}, #{workDate}, #{openTime}, #{closeTime}, #{slotMinutes}, #{carSpaces}, #{status}, NOW())
    </insert>

    <update id="updateSchedule" parameterType="com.ruoyi.booking.domain.DeptSchedule">
        UPDATE dept_schedule
        <trim prefix="SET" suffixOverrides=",">
            <if test="deptId != null">dept_id = #{deptId},</if>
            <if test="workDate != null">work_date = #{workDate},</if>
            <if test="openTime != null">open_time = #{openTime},</if>
            <if test="closeTime != null">close_time = #{closeTime},</if>
            <if test="slotMinutes != null">slot_minutes = #{slotMinutes},</if>
            <if test="carSpaces != null">car_spaces = #{carSpaces},</if>
            <if test="status != null">status = #{status},</if>
            update_time = NOW()
        </trim>
        WHERE id = #{id}
    </update>

    <delete id="deleteScheduleByIds">
        DELETE FROM dept_schedule WHERE id IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- ==================== 预约 ==================== -->
    <sql id="selectBookingVo">
        SELECT id, user_id, booking_no, dept_id, space_no, work_date,
               start_time, end_time, car_number, car_model, car_color,
               combo_name, combo_minutes, code, status,
               create_by, create_time, update_by, update_time
        FROM car_booking
    </sql>

    <select id="selectBookingList" parameterType="com.ruoyi.booking.domain.CarBooking" resultMap="BookingResult">
        <include refid="selectBookingVo"/>
        <where>
            <if test="deptId != null">AND dept_id = #{deptId}</if>
            <if test="workDate != null">AND work_date = #{workDate}</if>
            <if test="status != null">AND status = #{status}</if>
        </where>
        ORDER BY start_time
    </select>

    <select id="selectBookingByDeptIdAndDate" resultMap="BookingResult">
        <include refid="selectBookingVo"/>
        WHERE dept_id = #{deptId} AND work_date = #{workDate}
        AND status IN (0, 1)
        ORDER BY start_time
    </select>

    <select id="selectBookingByDeptIdAndDateRange" resultMap="BookingResult">
        <include refid="selectBookingVo"/>
        WHERE dept_id = #{deptId}
        AND work_date BETWEEN #{startDate} AND #{endDate}
        AND status IN (0, 1)
        ORDER BY work_date, start_time
    </select>

    <select id="selectBookingByCode" resultMap="BookingResult">
        <include refid="selectBookingVo"/> WHERE code = #{code}
    </select>

    <select id="countConflictBooking" resultType="int">
        SELECT COUNT(*) FROM car_booking
        WHERE dept_id = #{deptId}
          AND space_no = #{spaceNo}
          AND work_date = #{workDate}
          AND status IN (0, 1)
          AND (start_time &lt; #{endTime} AND end_time &gt; #{startTime})
    </select>

    <insert id="insertBooking" parameterType="com.ruoyi.booking.domain.CarBooking">
        INSERT INTO car_booking
        (user_id, booking_no, dept_id, space_no, work_date, start_time, end_time,
         car_number, car_model, car_color, combo_name, combo_minutes, code, status,
         create_by, create_time)
        VALUES
            (#{userId}, #{bookingNo}, #{deptId}, #{spaceNo}, #{workDate}, #{startTime}, #{endTime},
             #{carNumber}, #{carModel}, #{carColor}, #{comboName}, #{comboMinutes}, #{code}, #{status},
             #{createBy}, NOW())
    </insert>

    <update id="updateBooking" parameterType="com.ruoyi.booking.domain.CarBooking">
        UPDATE car_booking
        <trim prefix="SET" suffixOverrides=",">
            <if test="status != null">status = #{status},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            update_time = NOW()
        </trim>
        WHERE id = #{id}
    </update>

    <delete id="deleteBookingByIds">
        DELETE FROM car_booking WHERE id IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- ==================== 过期预约处理 ==================== -->
    <select id="selectExpiredBookings" resultMap="BookingResult">
        <include refid="selectBookingVo"/>
        WHERE end_time &lt; #{now}
    </select>

    <insert id="batchInsertHistory">
        INSERT INTO booking_history
        (user_id, booking_no, dept_id, space_no, work_date, start_time, end_time,
        car_number, car_model, car_color, combo_name, combo_minutes, code, status,
        create_by, create_time, update_by, update_time)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.userId}, #{item.bookingNo}, #{item.deptId}, #{item.spaceNo}, #{item.workDate},
            #{item.startTime}, #{item.endTime}, #{item.carNumber}, #{item.carModel},
            #{item.carColor}, #{item.comboName}, #{item.comboMinutes}, #{item.code},
            #{item.status}, #{item.createBy}, #{item.createTime},
            #{item.updateBy}, #{item.updateTime})
        </foreach>
    </insert>

    <!-- ==================== 我的预约 ==================== -->
    <select id="selectMyBookingList" resultMap="BookingResult">
        <include refid="selectBookingVo"/>
        WHERE user_id = #{userId}
        <if test="statusList != null and statusList.size() > 0">
            AND status IN
            <foreach collection="statusList" item="s" open="(" separator="," close=")">
                #{s}
            </foreach>
        </if>
        <if test="onlyNotExpired">
            AND end_time &gt; #{now}
        </if>
        ORDER BY start_time DESC
    </select>

    <select id="selectMyHistoryList" resultMap="BookingResult">
        SELECT id, user_id, booking_no, dept_id, space_no, work_date,
               start_time, end_time, car_number, car_model, car_color,
               combo_name, combo_minutes, code, status,
               create_by, create_time, update_by, update_time
        FROM booking_history
        WHERE user_id = #{userId}
        ORDER BY start_time DESC
            LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countMyHistory" resultType="int">
        SELECT COUNT(*) FROM booking_history WHERE user_id = #{userId}
    </select>

</mapper>